  name: Build & Release Flutter

  permissions:
    contents: write

  on:
    push:
      branches:
        - main

  jobs:
    build-android:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            distribution: 'temurin'
            java-version: '17'

        - name: Cache Flutter dependencies
          uses: actions/cache@v3
          with:
            path: |
              ~/.pub-cache
              build
            key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}

        - name: Set up Flutter
          uses: subosito/flutter-action@v2
          with:
            channel: 'stable'

        - name: Upgrade dependencies
          run: flutter pub upgrade

        - name: Build APK
          run: flutter build apk --release

        - name: Upload Android APK
          uses: actions/upload-artifact@v4
          with:
            name: android-apk
            path: build/app/outputs/flutter-apk/app-release.apk

    build-ios:
      runs-on: macos-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Set up Flutter
          uses: subosito/flutter-action@v2
          with:
            channel: 'stable'

        - name: Install CocoaPods (falls nötig) & deps
          run: |
            flutter pub get
            cd ios
            pod install --repo-update || true
            cd ..

        - name: Build IPA (unsigned)
          run: flutter build ipa --no-codesign

        - name: Debug - list build output
          run: |
            echo "Listing build/ios..."
            ls -la build/ios || true
            find build/ios -type f -maxdepth 6 -print || true

        - name: Collect iOS artifact (ipa / xcarchive / app)
          run: |
            mkdir -p artifacts/ios
            IPA=$(find build/ios -type f -name '*.ipa' -print -quit || true)
            XCARCHIVE=$(find build/ios -type d -name '*.xcarchive' -print -quit || true)
            APP=$(find build/ios -type d -name '*.app' -print -quit || true)

            if [ -n "$IPA" ]; then
              echo "Found ipa: $IPA"
              cp "$IPA" artifacts/ios/
            elif [ -n "$XCARCHIVE" ]; then
              echo "Found xcarchive: $XCARCHIVE - zipping..."
              ZIP=artifacts/ios/ios-archive.zip
              (cd "$(dirname "$XCARCHIVE")" && zip -r "$GITHUB_WORKSPACE/$ZIP" "$(basename "$XCARCHIVE")")
            elif [ -n "$APP" ]; then
              echo "Found .app: $APP - zipping..."
              mkdir -p tmp_payload
              BASENAME=$(basename "$APP")
              cp -R "$APP" tmp_payload/
              (cd tmp_payload && zip -r "$GITHUB_WORKSPACE/artifacts/ios/ios-app.zip" "$BASENAME")
              rm -rf tmp_payload
            else
              echo "❌ Keine ipa / xcarchive / .app unter \`build/ios/\` gefunden."
              exit 1
            fi

        - name: Upload iOS artifacts
          uses: actions/upload-artifact@v4
          with:
            name: ios-ipa
            path: artifacts/ios/**
            if-no-files-found: 'error'

    create-release:
      needs: [ build-android, build-ios ]
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Download Android APK
          uses: actions/download-artifact@v4
          with:
            name: android-apk
            path: artifacts/android

        - name: Download iOS IPA
          uses: actions/download-artifact@v4
          with:
            name: ios-ipa
            path: artifacts/ios

        - name: Generate Release Tag
          id: tag
          run: |
            COUNT=$(git tag | wc -l)
            NEW_TAG="v$((COUNT+1))"
            echo "new_tag=$NEW_TAG" >> $GITHUB_ENV
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag $NEW_TAG
            git push origin $NEW_TAG
            echo "Generated tag: $NEW_TAG"

        - name: Create GitHub Release
          uses: softprops/action-gh-release@v1
          with:
            tag_name: ${{ env.new_tag }}
            files: |
              artifacts/android/app-release.apk
              artifacts/ios/*.ipa
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}