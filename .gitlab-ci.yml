stages:
  - build
  - release

variables:
  FLUTTER_CHANNEL: "stable"
  FLUTTER_VERSION: "3.22.2"   # Passe auf deine Flutter-Version an
  ANDROID_SDK_ROOT: "/sdk"

before_script:
  - apt-get update -y
  - apt-get install -y curl unzip git wget openjdk-17-jdk
  - git clone https://github.com/flutter/flutter.git --branch $FLUTTER_CHANNEL --depth 1
  - export PATH="$PATH:`pwd`/flutter/bin"

build_android:
  stage: build
  image: ubuntu:22.04
  script:
    - flutter doctor
    - flutter pub get
    - flutter build apk --release
    - flutter build appbundle --release
  artifacts:
    paths:
      - build/app/outputs/flutter-apk/app-release.apk
      - build/app/outputs/bundle/release/app-release.aab
    expire_in: 1 week

release_github:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs: ["build_android"]
  script:
    - >
      release-cli create --name "Release $CI_COMMIT_TAG"
      --tag-name "$CI_COMMIT_TAG"
      --assets-link "{\"name\":\"app-release.apk\",\"url\":\"https://github.com/DEIN_GITHUB_USER/DEIN_REPO/releases/download/$CI_COMMIT_TAG/app-release.apk\"}"
      --assets-link "{\"name\":\"app-release.aab\",\"url\":\"https://github.com/DEIN_GITHUB_USER/DEIN_REPO/releases/download/$CI_COMMIT_TAG/app-release.aab\"}"

upload_github:
  stage: release
  image: curlimages/curl:latest
  needs: ["build_android"]
  script:
    - >
      curl -s https://api.github.com/repos/DEIN_GITHUB_USER/DEIN_REPO/releases/tags/$CI_COMMIT_TAG |
      jq -r '.upload_url' | sed 's/{?name,label}//' > upload_url.txt
    - UPLOAD_URL=$(cat upload_url.txt)
    - >
      curl -X POST -H "Authorization: token $GITHUB_TOKEN"
      -H "Content-Type: application/vnd.android.package-archive"
      --data-binary @build/app/outputs/flutter-apk/app-release.apk
      "$UPLOAD_URL?name=app-release.apk"
    - >
      curl -X POST -H "Authorization: token $GITHUB_TOKEN"
      -H "Content-Type: application/octet-stream"
      --data-binary @build/app/outputs/bundle/release/app-release.aab
      "$UPLOAD_URL?name=app-release.aab"
      
  only:
    - tags

